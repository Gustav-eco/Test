<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PING PONG — ARCADE</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');

  :root {
    --bg: #050810;
    --surface: #0a1020;
    --panel: #0d1628;
    --accent: #00f5ff;
    --accent2: #ff3e7f;
    --accent3: #ffe600;
    --text: #c8deff;
    --dim: #3a4a6a;
    --glow: 0 0 20px rgba(0,245,255,0.4);
    --glow2: 0 0 20px rgba(255,62,127,0.4);
    --drawer-w: 280px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Orbitron', monospace;
    overflow: hidden;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  /* Background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,245,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,245,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
  }

  /* ===== HEADER ===== */
  header {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    background: rgba(5,8,16,0.9);
    border-bottom: 1px solid rgba(0,245,255,0.15);
    z-index: 10;
    backdrop-filter: blur(10px);
  }

  .logo {
    font-size: 20px;
    font-weight: 900;
    letter-spacing: 6px;
    color: var(--accent);
    text-shadow: var(--glow);
  }

  .logo span { color: var(--accent2); text-shadow: var(--glow2); }

  .header-controls {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  /* ===== SCORE DISPLAY ===== */
  .scoreboard {
    position: fixed;
    top: 56px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 30px;
    padding: 10px 40px;
    background: rgba(10,16,32,0.8);
    border-bottom: 1px solid rgba(0,245,255,0.1);
    border-left: 1px solid rgba(0,245,255,0.1);
    border-right: 1px solid rgba(0,245,255,0.1);
    border-radius: 0 0 16px 16px;
    backdrop-filter: blur(10px);
    z-index: 9;
  }

  .score-side {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
  }

  .score-label {
    font-size: 9px;
    letter-spacing: 3px;
    color: var(--dim);
  }

  .score-label.you { color: var(--accent); }
  .score-label.ai { color: var(--accent2); }

  .score-value {
    font-size: 36px;
    font-weight: 900;
    line-height: 1;
  }

  .score-value.you { color: var(--accent); text-shadow: var(--glow); }
  .score-value.ai { color: var(--accent2); text-shadow: var(--glow2); }

  .score-sep {
    font-size: 28px;
    color: var(--dim);
    font-weight: 900;
  }

  /* ===== CANVAS WRAPPER ===== */
  .game-wrapper {
    margin-top: 56px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  canvas {
    display: block;
    border: 1px solid rgba(0,245,255,0.2);
    box-shadow:
      0 0 40px rgba(0,245,255,0.1),
      inset 0 0 60px rgba(0,0,20,0.5);
    border-radius: 4px;
  }

  /* ===== OVERLAY (start/pause/gameover) ===== */
  .overlay {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 20px;
    background: rgba(5,8,16,0.85);
    backdrop-filter: blur(6px);
    border-radius: 4px;
    z-index: 5;
    transition: opacity 0.3s;
  }

  .overlay.hidden { display: none; }

  .overlay-title {
    font-size: 32px;
    font-weight: 900;
    letter-spacing: 8px;
    color: var(--accent);
    text-shadow: var(--glow);
    text-align: center;
  }

  .overlay-sub {
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    color: var(--dim);
    letter-spacing: 2px;
    text-align: center;
  }

  /* ===== BUTTONS ===== */
  .btn {
    font-family: 'Orbitron', monospace;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 3px;
    padding: 10px 28px;
    border: 1px solid currentColor;
    background: transparent;
    cursor: pointer;
    transition: all 0.2s;
    border-radius: 3px;
    text-transform: uppercase;
  }

  .btn-primary {
    color: var(--accent);
    border-color: var(--accent);
  }
  .btn-primary:hover {
    background: var(--accent);
    color: var(--bg);
    box-shadow: var(--glow);
  }

  .btn-danger {
    color: var(--accent2);
    border-color: var(--accent2);
  }
  .btn-danger:hover {
    background: var(--accent2);
    color: var(--bg);
    box-shadow: var(--glow2);
  }

  .btn-pause {
    color: var(--accent3);
    border-color: var(--accent3);
    font-size: 10px;
  }
  .btn-pause:hover {
    background: var(--accent3);
    color: var(--bg);
  }

  /* ===== DIFFICULTY SELECTOR ===== */
  .diff-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .diff-btn {
    font-family: 'Orbitron', monospace;
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 2px;
    padding: 8px 16px;
    border: 1px solid var(--dim);
    background: transparent;
    color: var(--dim);
    cursor: pointer;
    transition: all 0.2s;
    border-radius: 3px;
    text-transform: uppercase;
  }

  .diff-btn:hover, .diff-btn.active {
    border-color: currentColor;
  }

  .diff-btn[data-diff="beginner"].active { color: #00ff88; border-color: #00ff88; background: rgba(0,255,136,0.1); box-shadow: 0 0 12px rgba(0,255,136,0.3); }
  .diff-btn[data-diff="intermediate"].active { color: var(--accent3); border-color: var(--accent3); background: rgba(255,230,0,0.1); box-shadow: 0 0 12px rgba(255,230,0,0.3); }
  .diff-btn[data-diff="hard"].active { color: var(--accent2); border-color: var(--accent2); background: rgba(255,62,127,0.1); box-shadow: 0 0 12px rgba(255,62,127,0.3); }
  .diff-btn[data-diff="impossible"].active { color: #ff1744; border-color: #ff1744; background: rgba(255,23,68,0.1); box-shadow: 0 0 16px rgba(255,23,68,0.5); }

  .diff-btn[data-diff="beginner"]:hover { color: #00ff88; }
  .diff-btn[data-diff="intermediate"]:hover { color: var(--accent3); }
  .diff-btn[data-diff="hard"]:hover { color: var(--accent2); }
  .diff-btn[data-diff="impossible"]:hover { color: #ff1744; }

  /* ===== DRAWER ===== */
  .drawer {
    position: fixed;
    top: 0; right: 0;
    width: var(--drawer-w);
    height: 100vh;
    background: var(--panel);
    border-left: 1px solid rgba(0,245,255,0.15);
    z-index: 20;
    transform: translateX(100%);
    transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
    display: flex;
    flex-direction: column;
    box-shadow: -10px 0 40px rgba(0,0,0,0.5);
  }

  .drawer.open {
    transform: translateX(0);
  }

  .drawer-toggle {
    position: fixed;
    top: 50%;
    right: 0;
    transform: translateY(-50%);
    width: 36px;
    height: 64px;
    background: var(--panel);
    border: 1px solid rgba(0,245,255,0.2);
    border-right: none;
    border-radius: 8px 0 0 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 21;
    transition: all 0.35s cubic-bezier(0.4,0,0.2,1);
    color: var(--accent);
  }

  .drawer-toggle:hover {
    background: rgba(0,245,255,0.1);
    box-shadow: -4px 0 16px rgba(0,245,255,0.2);
  }

  .drawer-toggle.open {
    right: var(--drawer-w);
  }

  .drawer-toggle svg {
    transition: transform 0.35s;
  }

  .drawer-toggle.open svg {
    transform: rotate(180deg);
  }

  .drawer-header {
    padding: 20px;
    border-bottom: 1px solid rgba(0,245,255,0.1);
    font-size: 11px;
    letter-spacing: 4px;
    color: var(--accent);
    font-weight: 700;
  }

  .drawer-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .setting-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .setting-label {
    font-size: 9px;
    letter-spacing: 3px;
    color: var(--dim);
    text-transform: uppercase;
  }

  .setting-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--accent);
    font-family: 'Share Tech Mono', monospace;
  }

  .slider-wrapper {
    position: relative;
  }

  input[type="range"] {
    width: 100%;
    -webkit-appearance: none;
    height: 3px;
    background: var(--dim);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: var(--glow);
    cursor: pointer;
    transition: transform 0.15s;
  }

  input[type="range"]::-webkit-slider-thumb:hover {
    transform: scale(1.3);
  }

  .speed-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 6px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 9px;
    color: var(--dim);
  }

  .drawer-divider {
    height: 1px;
    background: rgba(0,245,255,0.08);
  }

  .stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
  }

  .stat-row span:first-child { color: var(--dim); }
  .stat-row span:last-child { color: var(--text); }

  /* ===== CONTROLS HINT ===== */
  .controls-hint {
    position: fixed;
    bottom: 14px;
    left: 50%;
    transform: translateX(-50%);
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    color: var(--dim);
    letter-spacing: 2px;
    pointer-events: none;
  }

  /* ===== AI BADGE ===== */
  .ai-badge {
    position: absolute;
    top: 10px;
    right: 14px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 9px;
    color: var(--accent2);
    letter-spacing: 2px;
    opacity: 0.7;
  }

  .you-badge {
    position: absolute;
    top: 10px;
    left: 14px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 9px;
    color: var(--accent);
    letter-spacing: 2px;
    opacity: 0.7;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--dim); border-radius: 2px; }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">PING<span>PONG</span></div>
  <div class="header-controls">
    <div class="diff-group">
      <button class="diff-btn active" data-diff="beginner">PRINCIPIANTE</button>
      <button class="diff-btn" data-diff="intermediate">INTERMEDIO</button>
      <button class="diff-btn" data-diff="hard">DIFÍCIL</button>
      <button class="diff-btn" data-diff="impossible">IMPOSIBLE</button>
    </div>
    <button class="btn btn-pause" id="pauseBtn" style="display:none">⏸ PAUSA</button>
  </div>
</header>

<!-- SCOREBOARD -->
<div class="scoreboard">
  <div class="score-side">
    <div class="score-label you">TÚ</div>
    <div class="score-value you" id="scorePlayer">0</div>
  </div>
  <div class="score-sep">:</div>
  <div class="score-side">
    <div class="score-label ai">IA</div>
    <div class="score-value ai" id="scoreAI">0</div>
  </div>
</div>

<!-- GAME -->
<div class="game-wrapper">
  <div class="you-badge">◀ TÚ</div>
  <div class="ai-badge">IA ▶</div>
  <canvas id="canvas"></canvas>

  <!-- OVERLAY -->
  <div class="overlay" id="overlay">
    <div class="overlay-title" id="overlayTitle">PING PONG</div>
    <div class="overlay-sub" id="overlaySub">PRESIONA ESPACIO O CLIC PARA INICIAR</div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center">
      <button class="btn btn-primary" id="startBtn">▶ INICIAR</button>
    </div>
  </div>
</div>

<!-- CONTROLS HINT -->
<div class="controls-hint">W / S — MOVER PALETA &nbsp;|&nbsp; ESPACIO — PAUSA &nbsp;|&nbsp; ⚙ AJUSTES →</div>

<!-- DRAWER TOGGLE -->
<button class="drawer-toggle" id="drawerToggle" title="Ajustes">
  <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
    <path d="M9 2L4 7L9 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </svg>
</button>

<!-- DRAWER -->
<div class="drawer" id="drawer">
  <div class="drawer-header">⚙ AJUSTES</div>
  <div class="drawer-body">

    <div class="setting-group">
      <div class="setting-label">Velocidad de pelota</div>
      <div class="setting-value" id="speedLabel">Normal</div>
      <div class="slider-wrapper">
        <input type="range" id="speedSlider" min="1" max="5" step="1" value="2">
      </div>
      <div class="speed-labels">
        <span>5 Rápido</span>
        <span>7 Super</span>
        <span>9 Ultra</span>
        <span>11 Hiper</span>
        <span>14 MÁXIMO</span>
      </div>
    </div>

    <div class="drawer-divider"></div>

    <div class="setting-group">
      <div class="setting-label">Tamaño de paleta</div>
      <div class="setting-value" id="paddleLabel">Normal</div>
      <input type="range" id="paddleSlider" min="1" max="3" step="1" value="2">
      <div class="speed-labels">
        <span>Pequeña</span>
        <span>Normal</span>
        <span>Grande</span>
      </div>
    </div>

    <div class="drawer-divider"></div>

    <div class="setting-group">
      <div class="setting-label">Nivel actual</div>
      <div class="setting-value" id="diffLabel" style="font-size:13px; color:#00ff88">PRINCIPIANTE</div>
      <div style="font-family:'Share Tech Mono',monospace; font-size:10px; color:var(--dim); line-height:1.6; margin-top:4px" id="diffDesc">
        IA lenta, perfecta para aprender.
      </div>
    </div>

    <div class="drawer-divider"></div>

    <div class="setting-group">
      <div class="setting-label">Estadísticas</div>
      <div class="stat-row"><span>Tus puntos</span><span id="statYou">0</span></div>
      <div class="stat-row"><span>Puntos IA</span><span id="statAI">0</span></div>
      <div class="stat-row"><span>Rallies</span><span id="statRallies">0</span></div>
    </div>

    <div class="drawer-divider"></div>

    <button class="btn btn-danger" id="resetBtn" style="width:100%; margin-top:4px">↺ REINICIAR</button>

  </div>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

// Responsive canvas
function resizeCanvas() {
  const maxW = Math.min(window.innerWidth - 60, 820);
  const maxH = Math.min(window.innerHeight - 160, 520);
  canvas.width = Math.floor(maxW / 2) * 2;
  canvas.height = Math.floor(maxH / 2) * 2;
}
resizeCanvas();
window.addEventListener('resize', () => { resizeCanvas(); resetBall(); });

// ===== STATE =====
const PADDLE_W = 12;
let paddleH = 90;
const BALL_R = 7;

let speedBase = 5; // default speed level index 2

const SPEED_MAP = [5, 7, 9, 11, 14];
const SPEED_NAMES = ['Rápido', 'Super Rápido', 'Ultra Rápido', 'Hiper Rápido', 'MÁXIMO'];

const PADDLE_SIZES = [65, 90, 120];
const PADDLE_NAMES = ['Pequeña', 'Normal', 'Grande'];

// Difficulty configs
const DIFFICULTY = {
  beginner:     { aiSpeed: 2.2,  reaction: 0.06, errorChance: 0.25, name: 'PRINCIPIANTE', color: '#00ff88', desc: 'IA lenta, perfecta para aprender.' },
  intermediate: { aiSpeed: 3.8,  reaction: 0.12, errorChance: 0.12, name: 'INTERMEDIO',   color: '#ffe600', desc: 'IA moderada, buen reto para el jugador promedio.' },
  hard:         { aiSpeed: 5.5,  reaction: 0.20, errorChance: 0.04, name: 'DIFÍCIL',       color: '#ff3e7f', desc: 'IA rápida y casi perfecta. Requiere habilidad real.' },
  impossible:   { aiSpeed: 9.0,  reaction: 0.45, errorChance: 0.00, name: 'IMPOSIBLE',     color: '#ff1744', desc: '⚠ IA prácticamente imbatible. ¡Buena suerte!' },
};

let currentDiff = 'beginner';

let player = { x: 0, y: 0, w: PADDLE_W, h: paddleH, score: 0, vy: 0 };
let ai     = { x: 0, y: 0, w: PADDLE_W, h: paddleH, score: 0, targetY: 0 };
let ball   = { x: 0, y: 0, vx: 0, vy: 0, r: BALL_R };

let state = 'idle'; // idle | playing | paused | over
let rallyCount = 0;
let keys = {};
let aiErrorOffset = 0;

function initPositions() {
  player.x = 24;
  player.y = canvas.height / 2 - paddleH / 2;
  ai.x = canvas.width - 24 - PADDLE_W;
  ai.y = canvas.height / 2 - paddleH / 2;
  ai.targetY = ai.y;
}

function resetBall(dir = 1) {
  ball.x = canvas.width / 2;
  ball.y = canvas.height / 2;
  const angle = (Math.random() * 0.8 - 0.4);
  ball.vx = speedBase * dir * Math.cos(angle);
  ball.vy = speedBase * Math.sin(angle);
  aiErrorOffset = (Math.random() - 0.5) * paddleH * DIFFICULTY[currentDiff].errorChance * 4;
}

function init() {
  initPositions();
  resetBall();
}

// ===== INPUT =====
document.addEventListener('keydown', e => {
  keys[e.key] = true;
  if (e.code === 'Space') {
    e.preventDefault();
    if (state === 'idle') startGame();
    else if (state === 'playing') pauseGame();
    else if (state === 'paused') resumeGame();
  }
});
document.addEventListener('keyup', e => { keys[e.key] = false; });

// Mouse/touch control
canvas.addEventListener('mousemove', e => {
  if (state !== 'playing') return;
  const rect = canvas.getBoundingClientRect();
  const y = e.clientY - rect.top;
  player.y = Math.max(0, Math.min(canvas.height - paddleH, y - paddleH / 2));
});

canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  if (state !== 'playing') return;
  const rect = canvas.getBoundingClientRect();
  const y = e.touches[0].clientY - rect.top;
  player.y = Math.max(0, Math.min(canvas.height - paddleH, y - paddleH / 2));
}, { passive: false });

canvas.addEventListener('click', () => {
  if (state === 'idle') startGame();
});

// ===== GAME LOOP =====
let lastTime = 0;
let animId;

function loop(ts) {
  const dt = Math.min((ts - lastTime) / 16.67, 3);
  lastTime = ts;

  if (state === 'playing') {
    update(dt);
  }
  // Draw always runs (playing, serving, paused, over) so screen never freezes
  draw();
  animId = requestAnimationFrame(loop);
}

function update(dt) {
  // Player movement (keyboard)
  const pSpeed = 6;
  if (keys['w'] || keys['W'] || keys['ArrowUp'])    player.y -= pSpeed * dt;
  if (keys['s'] || keys['S'] || keys['ArrowDown'])  player.y += pSpeed * dt;
  player.y = Math.max(0, Math.min(canvas.height - paddleH, player.y));

  // Ball movement
  ball.x += ball.vx * dt;
  ball.y += ball.vy * dt;

  // Wall bounce top/bottom
  if (ball.y - ball.r <= 0) { ball.y = ball.r; ball.vy = Math.abs(ball.vy); }
  if (ball.y + ball.r >= canvas.height) { ball.y = canvas.height - ball.r; ball.vy = -Math.abs(ball.vy); }

  // Player paddle collision
  if (ball.vx < 0 &&
      ball.x - ball.r <= player.x + player.w &&
      ball.x + ball.r >= player.x &&
      ball.y >= player.y &&
      ball.y <= player.y + paddleH) {
    ball.x = player.x + player.w + ball.r;
    const hitY = (ball.y - (player.y + paddleH / 2)) / (paddleH / 2);
    const maxAngle = Math.PI / 3.2;
    const angle = hitY * maxAngle;
    const speed = Math.sqrt(ball.vx * ball.vx + ball.vy * ball.vy) * 1.05;
    ball.vx = Math.cos(angle) * speed;
    ball.vy = Math.sin(angle) * speed;
    if (ball.vx < 0) ball.vx = Math.abs(ball.vx);
    rallyCount++;
    aiErrorOffset = (Math.random() - 0.5) * paddleH * DIFFICULTY[currentDiff].errorChance * 4;
  }

  // AI paddle collision
  if (ball.vx > 0 &&
      ball.x + ball.r >= ai.x &&
      ball.x - ball.r <= ai.x + ai.w &&
      ball.y >= ai.y &&
      ball.y <= ai.y + paddleH) {
    ball.x = ai.x - ball.r;
    const hitY = (ball.y - (ai.y + paddleH / 2)) / (paddleH / 2);
    const maxAngle = Math.PI / 3.2;
    const angle = hitY * maxAngle;
    const speed = Math.sqrt(ball.vx * ball.vx + ball.vy * ball.vy) * 1.02;
    ball.vx = -Math.cos(angle) * speed;
    ball.vy = Math.sin(angle) * speed;
    if (ball.vx > 0) ball.vx = -Math.abs(ball.vx);
    rallyCount++;
  }

  // AI movement
  const diff = DIFFICULTY[currentDiff];
  if (ball.vx > 0) {
    // Ball coming to AI - calculate target with error
    ai.targetY = ball.y - paddleH / 2 + aiErrorOffset;
  } else {
    // Ball going away - AI returns to center
    ai.targetY = canvas.height / 2 - paddleH / 2;
  }

  const aiDelta = (ai.targetY - ai.y) * diff.reaction;
  const aiMoveMax = diff.aiSpeed * dt;
  ai.y += Math.max(-aiMoveMax, Math.min(aiMoveMax, aiDelta));
  ai.y = Math.max(0, Math.min(canvas.height - paddleH, ai.y));

  // Scoring
  if (ball.x - ball.r < 0) {
    ai.score++;
    updateScore();
    // Freeze ball immediately to prevent multiple triggers
    ball.vx = 0; ball.vy = 0;
    ball.x = canvas.width / 2;
    ball.y = canvas.height / 2;
    if (!checkGameOver()) serveBall(-1);
  } else if (ball.x + ball.r > canvas.width) {
    player.score++;
    updateScore();
    ball.vx = 0; ball.vy = 0;
    ball.x = canvas.width / 2;
    ball.y = canvas.height / 2;
    if (!checkGameOver()) serveBall(1);
  }
}

function serveBall(dir) {
  state = 'serving';
  setTimeout(() => {
    initPositions();
    resetBall(dir);
    state = 'playing';
  }, 900);
}

function checkGameOver() {
  const limit = 7;
  if (player.score >= limit || ai.score >= limit) {
    state = 'over';
    const won = player.score >= limit;
    showOverlay(
      won ? '¡GANASTE!' : 'PERDISTE',
      won ? `Venciste a la IA ${player.score}-${ai.score}` : `La IA ganó ${ai.score}-${player.score}`,
      true
    );
    document.getElementById('pauseBtn').style.display = 'none';
    return true;
  }
  return false;
}

function updateScore() {
  document.getElementById('scorePlayer').textContent = player.score;
  document.getElementById('scoreAI').textContent = ai.score;
  document.getElementById('statYou').textContent = player.score;
  document.getElementById('statAI').textContent = ai.score;
  document.getElementById('statRallies').textContent = rallyCount;
}

// ===== DRAW =====
function draw() {
  // Clear
  ctx.fillStyle = '#050810';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Center line dashed
  ctx.setLineDash([8, 12]);
  ctx.strokeStyle = 'rgba(0,245,255,0.08)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(canvas.width / 2, 0);
  ctx.lineTo(canvas.width / 2, canvas.height);
  ctx.stroke();
  ctx.setLineDash([]);

  // Center circle
  ctx.strokeStyle = 'rgba(0,245,255,0.05)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.arc(canvas.width / 2, canvas.height / 2, 60, 0, Math.PI * 2);
  ctx.stroke();

  // Player paddle
  drawPaddle(player.x, player.y, '#00f5ff', '#004466');

  // AI paddle
  drawPaddle(ai.x, ai.y, '#ff3e7f', '#440022');

  // Ball
  if (state === 'playing' || state === 'serving') {
    drawBall();
  }
}

function drawPaddle(x, y, color, shadow) {
  const gradient = ctx.createLinearGradient(x, y, x + PADDLE_W, y + paddleH);
  gradient.addColorStop(0, color);
  gradient.addColorStop(1, shadow);

  ctx.shadowBlur = 20;
  ctx.shadowColor = color;
  ctx.fillStyle = gradient;
  ctx.beginPath();
  ctx.roundRect(x, y, PADDLE_W, paddleH, 4);
  ctx.fill();
  ctx.shadowBlur = 0;
}

function drawBall() {
  ctx.shadowBlur = 20;
  ctx.shadowColor = '#ffffff';
  ctx.fillStyle = '#ffffff';
  ctx.beginPath();
  ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
  ctx.fill();

  // Trail
  ctx.shadowBlur = 8;
  ctx.shadowColor = 'rgba(0,245,255,0.5)';
  ctx.fillStyle = 'rgba(0,245,255,0.2)';
  ctx.beginPath();
  ctx.arc(ball.x - ball.vx * 2, ball.y - ball.vy * 2, ball.r * 0.7, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;
}

// ===== OVERLAY =====
function showOverlay(title, sub, showRestart = false) {
  const overlay = document.getElementById('overlay');
  document.getElementById('overlayTitle').textContent = title;
  document.getElementById('overlaySub').textContent = sub;
  const startBtn = document.getElementById('startBtn');
  startBtn.textContent = showRestart ? '↺ JUGAR DE NUEVO' : '▶ INICIAR';
  overlay.classList.remove('hidden');
}

function hideOverlay() {
  document.getElementById('overlay').classList.add('hidden');
}

// ===== CONTROLS =====
function startGame() {
  player.score = 0;
  ai.score = 0;
  rallyCount = 0;
  updateScore();
  init();
  state = 'playing';
  hideOverlay();
  document.getElementById('pauseBtn').style.display = 'block';
}

function pauseGame() {
  state = 'paused';
  document.getElementById('pauseBtn').textContent = '▶ CONTINUAR';
  showOverlay('PAUSA', 'PRESIONA ESPACIO PARA CONTINUAR');
}

function resumeGame() {
  state = 'playing';
  document.getElementById('pauseBtn').textContent = '⏸ PAUSA';
  hideOverlay();
}

// Pause button
document.getElementById('pauseBtn').addEventListener('click', () => {
  if (state === 'playing') pauseGame();
  else if (state === 'paused') resumeGame();
});

// Start button
document.getElementById('startBtn').addEventListener('click', startGame);

// Reset
document.getElementById('resetBtn').addEventListener('click', () => {
  state = 'idle';
  player.score = 0;
  ai.score = 0;
  rallyCount = 0;
  updateScore();
  init();
  document.getElementById('pauseBtn').style.display = 'none';
  document.getElementById('pauseBtn').textContent = '⏸ PAUSA';
  showOverlay('PING PONG', 'PRESIONA ESPACIO O CLIC PARA INICIAR');
});

// ===== DIFFICULTY =====
document.querySelectorAll('.diff-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentDiff = btn.dataset.diff;
    const d = DIFFICULTY[currentDiff];
    document.getElementById('diffLabel').textContent = d.name;
    document.getElementById('diffLabel').style.color = d.color;
    document.getElementById('diffDesc').textContent = d.desc;
  });
});

// ===== SPEED SLIDER =====
const speedSlider = document.getElementById('speedSlider');
speedSlider.addEventListener('input', () => {
  const idx = parseInt(speedSlider.value) - 1;
  speedBase = SPEED_MAP[idx];
  document.getElementById('speedLabel').textContent = SPEED_NAMES[idx];
});

// ===== PADDLE SLIDER =====
const paddleSlider = document.getElementById('paddleSlider');
paddleSlider.addEventListener('input', () => {
  const idx = parseInt(paddleSlider.value) - 1;
  paddleH = PADDLE_SIZES[idx];
  document.getElementById('paddleLabel').textContent = PADDLE_NAMES[idx];
  player.h = paddleH;
  ai.h = paddleH;
});

// ===== DRAWER =====
const drawer = document.getElementById('drawer');
const drawerToggle = document.getElementById('drawerToggle');

drawerToggle.addEventListener('click', () => {
  drawer.classList.toggle('open');
  drawerToggle.classList.toggle('open');
});

// ===== START =====
init();
showOverlay('PING PONG', 'PRESIONA ESPACIO O CLIC PARA INICIAR');
requestAnimationFrame(loop);
</script>
</body>
</html>
